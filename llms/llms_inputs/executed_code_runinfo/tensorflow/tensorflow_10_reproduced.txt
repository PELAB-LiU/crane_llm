# Executed Cells:
## Cell 1:

import tensorflow as tf
from transformers import TFAutoModel

## Cell 2:

import pandas as pd
import json
df_psytar = pd.read_csv("data/PsyTAR.csv")
df_psytar.head(5)

## Cell 3:



df=df_psytar

## Cell 4:

df_1 = df[df['ADR']==1]
df_0 = df[df['ADR']==0]

## Cell 5:

df_0 = df_0.sample(df_1.shape[0])

## Cell 6:

df = pd.concat([df_1,df_0])

## Cell 7:

from transformers import AutoTokenizer
tokenizer = AutoTokenizer.from_pretrained('bert-base-uncased')

## Cell 8:

def process_data(row):

    text = row['sentences']
    text = str(text)
    text = ' '.join(text.split())

    encodings = tokenizer(text, padding="max_length", truncation=True, max_length=128)

    label = 0
    if row['ADR'] == 1:
        label += 1

    encodings['label'] = label
    encodings['text'] = text

    return encodings

## Cell 9:

processed_data = []

for i in range(len(df[:1000])):
    processed_data.append(process_data(df.iloc[i]))

## Cell 10:

train_data = df["sentences"]
train_labels = df['ADR']

## Cell 11:

from sklearn.model_selection import train_test_split

new_df = pd.DataFrame(processed_data)

train_df, valid_df = train_test_split(
    new_df,
    test_size=0.2,
    random_state=2022
)

## Cell 12:

import pyarrow as pa
from datasets import Dataset

train_hg = Dataset(pa.Table.from_pandas(train_df))
valid_hg = Dataset(pa.Table.from_pandas(valid_df))

## Cell 13:

class HuggingFaceLayer(tf.keras.layers.Layer):
    def __init__(self, model_name, output_hidden_states=False, trainable=False, **kwargs):
        super(HuggingFaceLayer, self).__init__(**kwargs)
        self.model = TFAutoModel.from_pretrained(model_name, output_hidden_states=output_hidden_states)
        self.trainable = trainable

    def build(self, input_shape):
        self.model.built = True
        if not self.trainable:
            self.model.trainable = False
        super(HuggingFaceLayer, self).build(input_shape)

    def call(self, inputs, **kwargs):
        outputs = self.model(inputs, **kwargs)
        return outputs

## Cell 14:

model_name = 'bert-base-uncased'
model = tf.keras.Sequential()
model.add(HuggingFaceLayer(model_name=model_name))
model.add(tf.keras.layers.Dense(1, activation='sigmoid'))

# Current relevent runtime information:
{'__method__model_compile': {'type': "<class 'method'>"},
 '__method__model_fit': {'type': "<class 'method'>"},
 'model': {'execution_cell_source': {'cellno': 18, 'lineno': 2},
           'type': "<class 'keras.src.models.sequential.Sequential'>"},
 'train_data': {'execution_cell_source': {'cellno': 13, 'lineno': 1},
                'type': "<class 'pandas.core.series.Series'>",
                'value_info': {'num_unique': 4315,
                               'value_type': 'categorical or object'}},
 'train_labels': {'execution_cell_source': {'cellno': 13, 'lineno': 2},
                  'type': "<class 'pandas.core.series.Series'>",
                  'value_info': {'unique_values': [0.0, 1.0],
                                 'value_type': 'binary'}}}
# Target Cell:


model.compile(optimizer='adam', loss='binary_crossentropy', metrics=['accuracy'])
model.fit(train_data, train_labels, epochs=10)